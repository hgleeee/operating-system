# 문맥교환 (Context Switch)
## 문맥교환이란?
> 실행시킬 프로세스를 변경하기 위해 원래 수행 중이던 프로세스의 문맥을 저장하고 새로운 프로세스의 문맥을 세팅하는 과정

## 문맥교환이 일어나는 경우
1. 타이머 인터럽트가 발생하는 경우

  → 타이머 인터럽트에 의해 **다른 프로세스로 바뀌게 된다.**
  
2. 실행 상태에 있던 프로세스가 입출력 요청 등으로 봉쇄 상태로 바뀌는 경우

  → 입출력 요청으로 인해 봉쇄 상태로 바뀌어서 **다른 프로세스로 바뀌게 된다.**
  
### CPU 디스패치
> 준비 상태에 있는 프로세스들 중에서 CPU를 할당받을 프로세스를 선택한 후 실제로 CPU 제어권을 넘겨받는 과정

## 문맥교환 과정
1. 시스템 콜이나 인터럽트가 발생하여 커널의 호출이 필요한 상황이 발생
2. 프로그램 카운터나 레지스터 값 등 문맥 정보를 커널에 있는 해당 프로세스의 PCB에 저장
3. 현재 프로세스의 상태를 바꿔준다. (Running -> blocked or ready or exit)
4. 프로세스의 상태에 따라 PCB를 적절한 큐에 넣어준다. (Block Queue, Ready Queue 등)
5. 다음에 수행시킬 다른 프로세스를 선택
6. 선택된 프로세스의 상태를 Running으로 바꿔준다.
7. 선택된 프로세스의 문맥 정보를 복구
8. CPU는 새롭게 선택된 프로세스를 수행

## 타이머 인터럽트로 인한 문맥 교환
1. 사용자 프로세스가 CPU를 할당받고 실행되던 중 타이머 인터럽트가 발생하면 CPU의 제어권은 운영체제로 넘어간다.
2. 운영체제는 타이머 인터럽트 처리루틴으로 가서 직전까지 수행중이던 프로세스 문맥을 저장하고 새롭게 실행시킬 프로세스에 CPU를 이양한다.
3. 원래 수행중이던 프로세스는 준비 상태로 바뀌고 새롭게 CPU를 할당받은 프로세스는 실행 상태가 된다.
4. 원래 CPU를 보유중이던 프로세스는 자신의 PCB에 프로세스 카운터 값 등의 프로세스 문맥을 저장하고, 새롭게 CPU를 할당받을 프로세스는 에전에 저장한 자신의 문맥을 PCB로부터 실제 하드웨어로 복원시킨다.

## 입출력을 요청한 프로세스의 문맥 교환
1. 입출력을 요청한 프로세스는 디스크 입출력을 기다리는 큐에 줄섰다가 디스크 컨트롤러로부터 서비스를 받고 나면 디스크 컨트롤러가 CPU에게 인터럽트를 발생시켜 입출력이 완료되었다는 사실을 알린다.

  > __서비스__ : 마그네틱 매체에서 원하는 데이터를 로컬 버퍼로 불러옴

2. CPU는 인터럽트가 발생한 것을 확인하고 그에 대응하는 루틴 수행 

  > 이 때, CPU에서 수행되던 프로세스의 상태는 사용자모드 실행 상태에서 커널모드 실행 상태로 바뀐다.
  
4. 프로세스가 실행되던 중 인터럽트가 발생하면, 인터럽트가 발생한 원인과는 관계없이 인터럽트 당한 프로세스가 사용자모드에서 실행되다 커널모드로 진입한 것으로 간주한다.
5. 입출력이 완료된 프로세스 상태를 봉쇄 상태에서 준비 상태로 바꾼 후 장치의 로컬 버퍼에 있는 내용을 메모리로 이동시키는 업무 수행
6. 인터럽트 처리가 끝나면 인터럽트 처리 루틴 이전에 수행되던 프로세스에게 CPU 재할당
7. 경우에 따라서는 인터럽트 당한 프로세스에 CPU를 다시 할당하지 않고 입출력이 완료된 프로세스가 더 우선순위가 높을 경우 해당 프로세스에 CPU를 할당하는 경우도 있다. 

  > CPU 스케줄링 방식에 따라 달라지며 일반적이지 않음

## 프로세스가 바뀌지 않으면 문맥 교환이라고 하지 않는다.
- 타이머 인터럽트가 발생하거나 프로세스가 입출력 요청 시스템 콜을 하여 봉쇄 상태에 들어가는 경우에는 문맥교환이 일어나지만, 그 밖의 인터럽트나 시스템 콜 발생 시에는 문맥 교환이 일어나지 않고 실행 모드만이 변경될 뿐이다.
- 즉, 사용자모드에서 커널모드로 바뀌어 시스템 콜이나 인터럽트 처리를 하고 다시 동일한 프로세스의 사용자모드로 돌아와 이전에 수행하던 작업을 계속 수행할 뿐이다.

## 문맥교환의 비용
- 위에서 언급한 '모드 변경'에 비해 '문맥 교환'은 훨씬 많은 오버헤드가 뒤따르게 된다. 
- 문맥 교환에 소요되는 시간은 시스템 입장에서 볼 때 일종의 헤드라고 할 수 있다. 따라서 타이머에 CPU 할당시간을 아주 작게 세팅해 프로세스 간 문맥교환이 빈번하게 발생하도록 하면 이에 드는 오버헤드가 상당히 커진다. 
- 또 그 반대로 CPU 할당시간을 너무 크게 설정하면 시분할 시스템의 의미가 퇴색하게 되므로 적절한 CPU 할당시간을 정하는 것이 중요하다.
